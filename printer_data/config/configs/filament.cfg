[gcode_macro FILAMENT_LOAD]
gcode:
  LOAD_FILAMENT

[gcode_macro FILAMENT_UNLOAD]
gcode:
  UNLOAD_FILAMENT  

[gcode_macro FILAMENT_UNLOAD_ONE]
gcode:
  UNLOAD_ONE_FILAMENT 
  
[gcode_macro FILAMENT_UNLOAD_ALL]
gcode:
  UNLOAD_ALL_FILAMENT

[gcode_macro LOAD_FILAMENT]
gcode:
  RESPOND TYPE=command MSG='Loading filament'
  M104 S240
  G90 ; Absolute pos
  G1 X293 Y0 Z20 F1800 ; Move to center
  M104 S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83                           ; set extruder to relative
  G1 E80 F300                   ; extrude 5 cm
  G1 E-4 F1800                  ; retract some
  M82                           ; set extruder to absolute
  M400                          ; wait for buffer to clear
  RESPOND TYPE=command MSG='Done loading filament'

[gcode_macro UNLOAD_FILAMENT]
gcode:
  RESPOND TYPE=command MSG='Unloading filament'
  M104 S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
  M83                          ; set extruder to relative
  G1 E5 F500                   ; extrude 5 mm
  G1 E-50 F1000                ; retract 5 cm
  G1 E-50 F1000                ; retract 5 cm
  M82                          ; set extruder to absolute
  M400                         ; wait for buffer to clear
  RESPOND TYPE=command MSG='Done unloading filament'


[gcode_macro UNLOAD_ONE_FILAMENT]
gcode:
  RESPOND TYPE=command MSG='Unloading filament on ' {params.TOOL}
  M109 T{params.TOOL} S240 ;Wait until heated
  {% set tool_name = printer.toolchanger.tool_names[params.TOOL|int] %}
  {% set extruder = printer[tool_name].extruder %}
  M104 T{params.TOOL} S240 ;Heat up the filament
  TEMPERATURE_WAIT SENSOR={extruder} MINIMUM=240
  ACTIVATE_EXTRUDER EXTRUDER={extruder}
  M83                          ; set extruder to relative
  G1 E5 F500                   ; extrude 5 mm
  G1 E-50 F1000                ; retract 5 cm
  G1 E-50 F1000                ; retract 5 cm
  M82                          ; set extruder to absolute
  M400                         ; wait for buffer to clear
  RESPOND TYPE=command MSG='Done unloading filament'

[gcode_macro UNLOAD_ALL_FILAMENT]
gcode:
  {% set tools = printer.toolchanger.tool_names %}
  RESPOND TYPE=command MSG='Unloading all filament'
  {% for tool in tools %}
    M104 T{printer[tool].tool_number} S240 ;Heat up the filament
  {% endfor %}
  {% for tool in tools %}
    M109 T{printer[tool].tool_number} S240 ;Wait until heated
    ACTIVATE_EXTRUDER EXTRUDER={printer[tool].extruder}
    M83                             ; set extruder to relative
    G1 E5 F500                      ; extrude 5 mm
    G1 E-50 F1000                   ; retract 5 cm
    G1 E-50 F1000                   ; retract 5 cm
  {% endfor %}
  M400                              ; Finish all th emoves
  M82                               ; set extruder to absolute
  TURN_OFF_HEATERS
  RESPOND TYPE=command MSG='Done unloading all filament'

[gcode_macro CHANGE_NOZZLE]
gcode:
  RESPOND TYPE=command MSG='Changing nozzle'
  M104 S240
  G90 ; Absolute pos
  G1 X175 Y0 Z100 F1800 ; Move to front
  M109 S240 ;Heat up the filament
  M83                          ; set extruder to relative
  G1 E5 F250                   ; extrude 5 mm
  G1 E-50 F1000                ; retract 5 cm
  M82                          ; set extruder to absolute
  RESPOND TYPE=command MSG='Ready to swap'